<!DOCTYPE html><html class="appearance-light" lang="en"><head><meta charset="UTF-8"><title>Lỗ hổng Format String part 1</title><meta name="description" content="Zhong De mũm mĩm"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q || []).push(arguments)},i[r].l=1 * new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'G-WVGNR2SGBJ', 'auto');
ga('send', 'pageview');</script><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/bin.png"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="#Bản demo
TL;DRQua quá trình đọc một số bài viết Tiếng Việt về lỗ hổng này, mình thấy cảm thấy thiếu cho người muốn mày mò hiểu bản chất, chưa tổng hợp, hoặc các blog khác chỉ nói về cách khai thác(theo góc độ của mình). Qua chuỗi blog này, mình hi vọng sẽ cung cấp cho bạn đầy đủ về kỹ thuật Format string, dành cho người mới tìm hiểu.
Nội dung của các phần.."><meta name="generator" content="Hexo 7.0.0"></head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">Bai Zhong De's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Lỗ hổng Format String part 1</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#TL-DR"><span class="toc-text">TL;DR</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Cac-kien-thuc-can-biet"><span class="toc-text">1. Các kiến thức cần biết</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Architecture"><span class="toc-text">Architecture</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#32bit-vs-64bit"><span class="toc-text">32bit vs 64bit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Memory-Layout"><span class="toc-text">Memory Layout</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Function-call"><span class="toc-text">Function call</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FormatString-Vulnerablility"><span class="toc-text">FormatString Vulnerablility</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Intro"><span class="toc-text">Intro</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Impact"><span class="toc-text">Impact</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploit"><span class="toc-text">Exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Leakable-data"><span class="toc-text">Leakable data</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-text">Reference</span></a></li></ol></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/FormatString"><i class="tag post-item-tag">FormatString</i></a><a href="/tags/Pwnable"><i class="tag post-item-tag">Pwnable</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">Lỗ hổng Format String part 1</h1><time class="has-text-grey" datetime="2023-12-05T04:40:04.000Z">2023-12-05</time><article class="mt-2 post-content"><p>#Bản demo</p>
<h1 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h1><p>Qua quá trình đọc một số bài viết Tiếng Việt về lỗ hổng này, mình thấy cảm thấy thiếu cho người muốn mày mò hiểu bản chất, chưa tổng hợp, hoặc các blog khác chỉ nói về cách khai thác(theo góc độ của mình). Qua chuỗi blog này, mình hi vọng sẽ cung cấp cho bạn đầy đủ về kỹ thuật Format string, <strong>dành cho người mới tìm hiểu</strong>.</p>
<p>Nội dung của các phần dự kiến như sau:</p>
<ul>
<li>Part1: Các kiến thức lý thuyết cơ bản của ngôn ngữ C và lỗi Format String. </li>
<li>Part2: Mô tả cách lợi dụng lỗ hổng Format String để leak dữ liệu trong bộ nhớ. [Dự kiến 2025]</li>
<li>Part3: Mô tả cách lợi dụng lỗ hổng Format String để ghi đè giá trị tùy ý. [Dự kiến 2038]</li>
</ul>
<p><em>Lưu ý</em>: Trong chuỗi blog này, mình sẽ demo trên lập trình C&#x2F;C++, hệ điều hành Unix [Ubuntu 20.04]. Có thể một vài nội dung truyền tải sai&#x2F;chưa đúng. Xin nhận góp ý thông qua Github.<br>Các bạn cần biết qua về lỗ hổng BOF trước khi đến với lỗ hổng FormatString.</p>
<blockquote>
<p><em>Hello, mình là Bai Zhong De!</em></p>
</blockquote>
<p><strong>Sample</strong></p>
<p>Với các bạn mới chơi CTF đôi khi sẽ có các bài dạng lĩnh vực Pwable&#x2F;Exploit&#x2F;Binary liên quan đến lỗi Format string và các bạn thấy người ta chỉ <code>AAAAAAAA%x%x%x%x%x%x</code> hoặc <code>%37$s</code> chẳng hạn thì sẽ lấy được nội dung <code>flag</code> mặc dù file thực thi không có câu lệnh in ra nội dung file flag.txt.</p>
<p>Dưới đây là một ví dụ: Dịch vụ chạy ELF <code>pandafmt</code> trên server được cung cấp cho người chơi, yêu cầu đọc nội dung file flag ở trên server đó.</p>
<p>Lập trình <em>fmt.c:</em></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//*Hãy tự đọc hiểu chương trình trước khi tiếp tục.*</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ignore</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">vuln</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ignore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="built_in">setvbuf</span>(stdout, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">	<span class="built_in">setvbuf</span>(stdin, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">setvbuf</span>(stderr, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">vuln</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="type">char</span> flag[<span class="number">27</span>];</span><br><span class="line">	<span class="type">char</span> yourname[<span class="number">128</span>];</span><br><span class="line">	FILE *fp;</span><br><span class="line">	fp = <span class="built_in">fopen</span>(<span class="string">&quot;flag.txt&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(fp == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;No file flag.txt&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">fgets</span>(flag,<span class="number">27</span>,fp);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;Input your name: &quot;</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%128s&quot;</span>,yourname);</span><br><span class="line">	<span class="built_in">printf</span>(yourname);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">ignore</span>();</span><br><span class="line">	<span class="built_in">vuln</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>Biên dịch chương trình C:</em></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -o pandafmt fmt.c</span><br></pre></td></tr></table></figure>
<p><em>Nội dung file flag.txt:</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cutepanda&#123;flag&#125;</span><br></pre></td></tr></table></figure>
<p><em>Khai thác thông qua lỗ hổng Format string(cứ biết thế đã nhé :&lt;):</em></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./pandafmt</span><br><span class="line">Input your name: </span><br><span class="line">%8<span class="variable">$p</span>.%9<span class="variable">$p</span></span><br><span class="line">0x646e617065747563.0xa7d67616c667b61</span><br></pre></td></tr></table></figure>
<p>Chúng ta có thể thấy giá trị <code>0x64 6e 61 70 65 74 75 63</code> và <code>0x0a 7d 67 61 6c 66 7b 61</code> khi chuyển từ hexa sang giá trị ASCII là <code>cutepanda&#123;flag&#125;</code>. Đây chính là <code>flag</code> mà chúng ta cần tìm. Có thể sử dụng các công cụ online để chuyển đổi <a target="_blank" rel="noopener" href="https://kt.gy/tools.html#conv/">kt.gy</a> hoặc công cụ mạnh hơn <a target="_blank" rel="noopener" href="https://gchq.github.io/CyberChef/">Cyber Chef</a>.</p>
<h1 id="1-Cac-kien-thuc-can-biet"><a href="#1-Cac-kien-thuc-can-biet" class="headerlink" title="1. Các kiến thức cần biết"></a>1. Các kiến thức cần biết</h1><p>Như mình nói ban đầu, có thể mọi người đã làm được những bước như này nhưng mong muốn hiểu được bản chất, thì mình sẽ ở đây trao đổi với mọi người. Vì đây là blog đầu tiên liên quan đến một số kiến thức khai thác lỗ hổng <strong>cơ bản</strong>, nhưng không bắt đầu từ lỗi Buffer Overflow, nên mình sẽ tổng hợp các kiến thức khác đi kèm, mọi người nên đọc qua. Ý kiến riêng thì các bạn cần biết lỗ hổng BOF(Buffer Over Flow) trước khi qua lỗ hổng Format String.</p>
<p>Let’s go… </p>
<h2 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h2><h3 id="32bit-vs-64bit"><a href="#32bit-vs-64bit" class="headerlink" title="32bit vs 64bit"></a>32bit vs 64bit</h3><p>Hiện tại trong các kiến trúc có 32bit(x86) và 64bit(x64). Muốn hiểu rõ hơn các thành phần, các bạn có thể tìm hiểu <a target="_blank" rel="noopener" href="https://www.tutorialspoint.com/computer_fundamentals/computer_components.htm">tại đây</a>.<br>Đại loại, với mỗi hệ thống, thì bộ xử lý, bộ nhớ, các thành phần khác sẽ xử lý tương ứng trên các đơn vị 32bit hay 64bit.</p>
<h3 id="Memory-Layout"><a href="#Memory-Layout" class="headerlink" title="Memory Layout"></a>Memory Layout</h3><p>Chúng ta đều biết, máy tính chỉ hoạt động qua ngôn ngữ máy, các bit <code>0</code> <code>1</code>, vì vậy để máy tính hiểu được chương trình, cần có quá trình biên dịch (<code>compiler</code>) quá trình này sẽ chuyển từ ngôn ngữ bậc cao(dễ viết, dễ đọc, dễ hiểu) sang ngôn ngữ bậc thấp hơn(ngôn ngữ máy). Vậy thì chương trình C của chúng ta cũng có trình biên dịch như thế(file .c&#x2F;.cpp -&gt; .. -&gt; Assembly -&gt; .. -&gt; 0110), cho nên nó cần có các vùng nhớ( hay còn gọi là memory), chủ yếu là vùng nhớ của RAM, để thực hiện lưu trữ dữ liệu chương trình. Qua đó, Bộ phận xử lý Trung tâm (Central Processing Unit&#x2F;CPU) của máy tính sẽ lấy các dữ liệu này để tính toán và xử lý. </p>
<blockquote>
<p>CPU là mạch điện tử thực hiện các câu lệnh của chương trình máy tính bằng cách thực hiện các phép tính số học, logic, so sánh và các hoạt động nhập&#x2F;xuất dữ liệu (Input&#x2F;Output) cơ bản từ mã lệnh được định sẵn trong một máy tính.</p>
</blockquote>
<p>Ngôn ngữ lập trình C hoạt động bằng cách ghi đoạn mã của bạn vào một tệp thực thi(VD: PE file trên Windows, ELF file trên hệ thống Unix như Ubuntu, Kali,…). Trình biên dịch C sẽ lấy tệp thực thi đó và chuyển đổi toàn bộ thành mã máy, sau đó sẽ được máy tính của bạn thực thi khi chạy chương trình.</p>
<p>Thông thường, khi chương trình biên dịch được chạy(PE, ELF) thì dữ liệu của chương trình đó sẽ được lưu trong thanh RAM của máy tính.</p>
<blockquote>
<p>RAM (viết tắt của Random Access Memory) là một loại bộ nhớ khả biến cho phép truy xuất đọc-ghi ngẫu nhiên đến bất kỳ vị trí nào trong bộ nhớ dựa theo địa chỉ bộ nhớ. Thông tin lưu trên RAM chỉ là tạm thời, chúng sẽ mất đi khi mất nguồn điện cung cấp.<br>Bộ nhớ của chương trình C khi được chạy(lưu trong RAM) bao gồm các phần sau:</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">Segment</th>
<th align="center">Ý nghĩa</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Text segment</td>
<td align="center">.text chứa các đoạn mã lệnh chương trình</td>
</tr>
<tr>
<td align="center">Initialized data segment</td>
<td align="center">.data Chứa các biến global, static nếu các biến này được khởi tạo khác 0</td>
</tr>
<tr>
<td align="center">Uninitialized data segment</td>
<td align="center">.bss Chứa các biến global, static nếu không khai báo giá trị&#x2F;hoặc gán giá trị bằng 0</td>
</tr>
<tr>
<td align="center">Heap (Dynamic Memory Allocation)</td>
<td align="center">Cấp phát, giải phóng bộ nhớ qua các hàm như malloc, calloc, free, delete, new,…</td>
</tr>
<tr>
<td align="center">Stack (Automatic Variable Storage)</td>
<td align="center">Vùng nhớ cấp phát tự động LIFO(Last In First Out)</td>
</tr>
</tbody></table>
<p>Qúa trình phát triển bộ nhớ(gọi thêm hàm, khai báo,…) sẽ có chiều hướng phát triển trong memory như sau.</p>
<p>Highaddress <img src="/../images/Lo-hong-format-string-part-1/Program_memory_layout.pdf.jpg"> Lowaddress</p>
<p>Trong các vùng nhớ, chúng ta có <code>địa chỉ</code> và <code>giá trị</code> tại địa chỉ đó.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> a = <span class="number">197</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, &amp;a); <span class="comment">// = 0x658741 địa chỉ</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, a); <span class="comment">// = 197 giá trị</span></span><br></pre></td></tr></table></figure>
<p>Trong thanh RAM, có vùng nhớ Stack và Heap, mỗi khi một hàm trong chương trình chạy sẽ được cấp phát một vùng trên Stack. Và Stack sẽ hoạt động cách cấp phát từ địa chỉ cao hơn (HighAddress) -&gt; sang địa chỉ thấp hơn (LowAddress). Ví dụ, hàm thứ <code>1</code> chương trình chạy trước và chưa dừng lại thì chương trình <code>1</code> sẽ được cấp vùng nhớ stack tại địa chỉ 0x10101010, nếu hàm thứ <code>2</code> chạy sau sẽ được cấp phát tại địa chỉ 0x10100000 chẳng hạn.<br>Và Heap sẽ ngược lại từ LowAddress -&gt; HighAddress.</p>
<h3 id="Function-call"><a href="#Function-call" class="headerlink" title="Function call"></a>Function call</h3><p>Quá trình chương trình thực hiện, sẽ gọi các hàm liên tục (thông qua <code>call</code> trong Assembly), sau đó lại quay trở về tại thời điểm trước khi gọi hàm đó( thông qua <code>ret</code>).</p>
<p>Cùng nhìn lại <em>fmt.c</em>: Tại <code>main</code> chương trình gọi 2 hàm là <code>ignore</code> và <code>vuln</code> (cái này ai từng thực hiện về lỗ hổng Buffer Overflow sẽ hiểu rõ). Khi chương trình chạy hàm <code>main</code>, stack sẽ cấp phát một vùng nhớ cho chương trình, khi hàm <code>main</code> chưa kết thúc thì vùng nhớ đã được cấp phát sẽ được giữ nguyên.<br>Khi hàm <code>main</code> gọi hàm <code>ignore()</code> thì chương trình sẽ sử dụng lệnh <code>call ignore</code>(giai đoạn này sẽ phải cấp phát một vùng nhớ để lưu các biến, EBP, return address,.. và vùng nhớ này sẽ có địa chỉa thấp hơn vùng địa chỉ <code>main</code> đã được stack cấp phát trước đó) và thực hiện hàm <code>ignore</code> cho xong mới quay lại tiếp thực hiện hàm <code>main</code>. Sau khi chạy xong hàm <code>ignore</code> thì chương trình phải về hàm <code>main</code> để thực hiện tiếp hàm <code>vuln</code>, giai đoạn trở về thông qua địa chỉ trả về <code>return address</code>.</p>
<p>Trong chương trình sẽ có nhiều hàm khác nhau, mỗi phân vùng trên stack được cấp cho một hàm, khi hàm chưa kết thúc, và hàm giữ liên tục phân vùng này trên stack thì gọi là <code>StackFrame</code>.</p>
<p>Vậy mỗi <code>StackFrame</code> có chứa những cái gì?<br><strong><em>x86</em></strong><br>Trong hệ điều hành 32bit, <code>StackFrame</code> khi một hàm trong chương trình được gọi (vùng nhớ mà stack cấp phát cho hàm) sẽ như sau:</p>
<p>Ví dụ chương trình có hàm sau:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">vuln</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span>&#123;</span><br><span class="line">    <span class="type">int</span> x = <span class="number">5</span>;</span><br><span class="line">	vuln(<span class="type">int</span> a, <span class="type">char</span> *b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>khi hàm <code>vuln</code> chưa kết thúc thì thì <code>StackFrame</code> của hai hàm <code>main</code> và <code>vuln</code> sẽ như thế này:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[Highaddress]</span><br><span class="line">    [........]</span><br><span class="line">    [ebp + 16] (3rd function argument)</span><br><span class="line">    [ebp + 12] (2nd argument)</span><br><span class="line">    [ebp +  8] (1st argument)</span><br><span class="line">main[ebp +  4] (return address)</span><br><span class="line">    [ebp     ] (old ebp value)  </span><br><span class="line">    [ebp -  4] (1st local variable) //x = 5</span><br><span class="line">    [ebp -  8] (2st local variable)</span><br><span class="line">    [........]</span><br><span class="line">    [........]</span><br><span class="line">    [........]</span><br><span class="line">    [........]</span><br><span class="line">    [ebp + 16] (3rd function argument)</span><br><span class="line">    [ebp + 12] (2nd argument)  //b</span><br><span class="line">    [ebp +  8] (1st argument) //a</span><br><span class="line">vuln[ebp +  4] (return address)</span><br><span class="line">    [ebp     ] (old ebp value) &lt;- ESP new</span><br><span class="line">    [ebp -  4] (1st local variable)</span><br><span class="line">    [ebp -  8] (2st local variable)</span><br><span class="line">    [........]</span><br><span class="line">    [Lowaddress]</span><br></pre></td></tr></table></figure>
<p><em>Oops:</em></p>
<p><em>- Argument là đối số khi được gọi hàm, Parameter là tham số của hàm khi định nghĩa hàm</em></p>
<p><em>- Trong hệ điều hành 32bit thì các tham số của hàm được cấp phát nằm năm phía trên EBP</em></p>
<p>Khung phía trên là stack của chúng ta, hàm <code>main</code> vẫn chưa kết thúc nên vẫn giữ được <code>StackFrame</code> của hàm <code>main</code>, sau đó hàm <code>main</code> gọi hàm <code>vuln</code> cho nên stack cần cấp phát thêm một vùng nhớ để chạy hàm <code>vuln</code>, vùng nhớ này nằm phía dưới ngẫu nhiên không quá xa so với hàm <code>main</code>.</p>
<p><strong><em>x64</em></strong><br>Hơi khác với 32bit, kiến trúc 64bit 6 con con trỏ tham số sẽ được lưu trữ lần lượt trong các thanh ghi <em>RDI, RSI, RDX, RCX, R8 và R9</em>, nếu có thêm các tham số thì sẽ được lưu trên stack.</p>
<p>[Highaddress]<br>[…]<br>[rbp + 16] (maybe 9th function argument)<br>[rbp + 12] (maybe 8th argument)<br>[rbp + 8]  (maybe 7th argument)<br>[rbp + 4]  (return address)<br>[rbp]      (old ebp value)<br>[rbp - 4]  (1st local variable)<br>[rbp - 8]  (2st local variable)<br>[….]<br>[Lowaddress]</p>
<h2 id="FormatString-Vulnerablility"><a href="#FormatString-Vulnerablility" class="headerlink" title="FormatString Vulnerablility"></a>FormatString Vulnerablility</h2><h3 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h3><p>Lỗi format string là một lỗi nguy hiểm không thua gì lỗi tràn bộ đệm. Khi một chương trình có lỗi này, hacker có thể leak dữ liệu, làm crash chương trình, và thậm chí là khai thác chạy các chương trình độc hại.<br>Format string là chuỗi string để định dạng dữ liệu in ra trong các hàm <strong>printf, fprintf, sprintf, snprintf, vsprintf, vsnprintf vfprintf, vprintf,…</strong> sẽ sử dụng tham số thứ nhất là chuỗi định đạng.<br>Cấu trúc được thiết của các hàm in ra trong lập trình C.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *format, ...)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">fprintf</span><span class="params">(FILE *stream, <span class="type">const</span> <span class="type">char</span> *format, ...)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">dprintf</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">char</span> *format, ...)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">sprintf</span><span class="params">(<span class="type">char</span> *str, <span class="type">const</span> <span class="type">char</span> *format, ...)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">snprintf</span><span class="params">(<span class="type">char</span> *str, <span class="type">size_t</span> size, <span class="type">const</span> <span class="type">char</span> *format, ...)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdarg.h&gt;</span></span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">vprintf</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *format, va_list ap)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">vfprintf</span><span class="params">(FILE *stream, <span class="type">const</span> <span class="type">char</span> *format, va_list ap)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">vdprintf</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">char</span> *format, va_list ap)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">vsprintf</span><span class="params">(<span class="type">char</span> *str, <span class="type">const</span> <span class="type">char</span> *format, va_list ap)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">vsnprintf</span><span class="params">(<span class="type">char</span> *str, <span class="type">size_t</span> size, <span class="type">const</span> <span class="type">char</span> *format, va_list ap)</span>;</span><br></pre></td></tr></table></figure>
<p>Trong chuỗi blog này, chúng ta sẽ mô phỏng hoạt động của một hàm <code>printf</code> bình thường</p>
<p><em>Trước khi tiếp tục: stdin, stdout, stder là các con trỏ tiêu chuẩn cho việc input, output, và error output. Mặc địch, chuẩn input sẽ đọc dữ liệu từ bàn phím, chuẩn output và error output sẽ in ra màn hình</em> </p>
<p><code>int printf ( const char * format, ... );</code> ý nghĩa hàm <code>printf</code> là sẽ ghi chuỗi được trỏ bởi <code>const char *format*</code> vào thanh ghi vào luồng <code>stdout</code> -&gt; có nghĩa là nó sẽ in ra màn hình chuỗi được trỏ bở con trỏ <code>format</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Hello cutepanda&quot;</span>); <span class="comment">//in ra màn hình &quot;Hello cutepanda&quot; &lt;=&gt;  *format = chuỗi &quot;Hello cutepanda&quot;</span></span><br></pre></td></tr></table></figure>
<p>Đặc biệt, nếu muốn bổ sung thêm các đối số thì chúng ta không thể viết kiểu:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//a.c</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Hello &quot;</span>,<span class="string">&quot;cutepanda&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>thì sẽ có lỗi sau</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$gcc</span> a.c</span><br><span class="line">a.c: In <span class="keyword">function</span> ‘main’:</span><br><span class="line">a.c:4:16: warning: too many arguments <span class="keyword">for</span> format [-Wformat-extra-args]</span><br><span class="line">    4 |         <span class="built_in">printf</span>(<span class="string">&quot;Hello &quot;</span>, <span class="string">&quot;cutepanda&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>Với nhu cầu như thế, trong lập trình C&#x2F;C++ có thể thay thế một số nội dung trong trong <em>format</em> bằng cách thêm một số <strong>format specifiers</strong>(định dạng được chỉ định, chỉ định ở đây có thể hiểu là cách hiển thị ra màn hình dạng số, chữ, hexa,…), các <em>format sepectifiers</em> này được bắt đầu bằng ký tự <code>%</code> và bổ sung đối số tiếp theo trong hàm <code>printf</code>. </p>
<p>Một số <strong>format specifiers</strong>:</p>
<table>
<thead>
<tr>
<th align="left">specifies</th>
<th align="left">Output</th>
</tr>
</thead>
<tbody><tr>
<td align="left">%d hoặc %i</td>
<td align="left">Số thập phân có dấu(dấu - đó &#x3D; )))</td>
</tr>
<tr>
<td align="left">%u</td>
<td align="left">Số thập phân không dấu</td>
</tr>
<tr>
<td align="left">%x</td>
<td align="left">Số dạng hexa</td>
</tr>
<tr>
<td align="left">%s</td>
<td align="left">Chuỗi ký tự</td>
</tr>
<tr>
<td align="left">%p</td>
<td align="left">Dạng một địa chỉ con trỏ (Có thêm 0x)</td>
</tr>
<tr>
<td align="left">%n</td>
<td align="left">Trường hợp đặc biệt, không in ra màn hình, đối số tương ứng với nó là một số không dấu, số ký tự được ghi vào stdout(&lt;&#x3D;&gt;in ra màn hình) sẽ được lưu vào vị trí chỉ định(đối số của nó)</td>
</tr>
<tr>
<td align="left">%%</td>
<td align="left">Nếu có % cạnh phía sau % khác thì sẽ in ra 1 ký tự %</td>
</tr>
<tr>
<td align="left">Và nhiều cái khác nữa</td>
<td align="left">Hiccc</td>
</tr>
</tbody></table>
<p>Và có nhiều <code>flags</code> của hàm <code>printf</code> để định dạng cách in.<br>Ví dụ cụ thể: </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Hello %s&quot;</span>, <span class="string">&quot;cutepanda&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>ở ví dụ này, <code>format</code> là <code>Hello %s</code>, <code>format specifiers</code> là <code>%s</code>, do có thêm một <code>format specifiers</code> nên ta phải thêm một đối số, đó là chuỗi <code>cutepanda</code>. Ở đây, có nghĩa là chương trình sẽ in ra chuỗi <code>Hello cutepanda</code>. </p>
<p>Đấy là cách hoạt động của hàm <code>printf</code> trong lập trình C.</p>
<p>Vậy, <strong>lỗi format string xảy ra khi nào?</strong><br>Đó là khi một hàm in trong chuỗi <em>format</em> có chứa các <em>format specifiers</em> nhưng không đủ đối số tương ứng cho <em>format specifiers</em> . Đại loại lập trình không đúng với thiết kế của ngôn ngữ C.<br>Ví dụ, khi lập trình với hàm <code>printf</code> đây là lỗi:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">printf(&quot;Hello %s %s&quot;,&quot;cutepanda&quot;); //Lỗi. 2 %s nhưng chỉ có một đối số.</span><br><span class="line">printf(&quot;Hello %x&quot;); //Lỗi. 1 %x nhưng lại không có đối số.</span><br><span class="line">printf(&quot;%x&quot;); //Lỗi. %x nhưng lại không có đối số.</span><br><span class="line">printf(&quot;%%x&quot;); //Không lỗi. Chương trình in ra &quot;%x&quot;.</span><br></pre></td></tr></table></figure>

<p>Cuối cùng, làm sao có thể tận dụng lỗi format string để khai thác được lỗ hổng, đó là khi nếu bạn có thể kiểm soát được chuỗi <code>format</code> của hàm <code>printf</code> thì bạn có thể tận dụng các lỗ hổng này để hack hệ thống.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *name == vị trí có thể kiểm soát(nhập tên từ bàn phím, nhập tên từ file,...);</span><br><span class="line"><span class="built_in">printf</span>(name); =&gt; Đây là nơi mà chúng ta sẽ tận dụng khai thác lỗi.</span><br></pre></td></tr></table></figure>
<h3 id="Impact"><a href="#Impact" class="headerlink" title="Impact"></a>Impact</h3><p>Khai thác lỗ hổng Format string có hai phần quà bạn có thể tận dụng, cần xuyên suốt trong quá trình tìm hiểu này.</p>
<ul>
<li><strong>Leak dữ liệu trên stack.</strong></li>
<li><strong>Ghi đè vào một địa chỉ tùy ý, nếu vùng nhớ này chúng ta có quyền ghi (rwx read-write-excute).</strong></li>
</ul>
<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><h3 id="Leakable-data"><a href="#Leakable-data" class="headerlink" title="Leakable data"></a>Leakable data</h3><p>Như ví dụ đầu blog, khi chạy chương trình, <code>./pandafmt</code>, về đúng nguyên tắc của lập trình, chúng ta không thể đọc được nội dung của <code>flag.txt</code>. Tuy nhiên, chúng ta đã đọc được nội dung của <code>flag.txt</code> thông qua lỗ hổng FormatString. Vậy, nguyên lý nào khiến chúng ta có thể làm điều đó?  Part2 mình sẽ giải thích.<br>Rất vui khi được các bạn chia sẻ cho những bạn khác, từ nguồn này.</p>
<blockquote>
<p>Bye, mình là Cute Panda &lt;3</p>
</blockquote>
<p><strong>End part1.</strong></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.tutorialspoint.com/computer_fundamentals/computer_components.htm">Computer Components</a></li>
<li><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/memory-layout-of-c-program/">Memory layout of C Programe</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/File:Program_memory_layout.pdf">Programe Memory PDF</a></li>
<li><a target="_blank" rel="noopener" href="https://ctf-wiki.org/">CTF Wiki</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/clover-toeic/p/3755401.html">C language function call stack (1)</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/clover-toeic/p/3756668.html">C language function call stack (2)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bluemoon.com.vn/books/taose.pdf">Nghệ thuật tận dụng lỗi phần mềm</a></li>
<li><a target="_blank" rel="noopener" href="https://ctf101.org/binary-exploitation/what-is-the-stack/">The Stack</a></li>
</ul>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><em></em><a class="button is-default" href="/2023/11/22/Phishing-tancongnguoidungwindows/" title="Phishing tấn công người dùng Windows"><span class="has-text-weight-semibold">Next: Phishing tấn công người dùng Windows</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="baizhongde/baizhongde.github.io" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/baizhongde"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--></section><p><span>Copyright ©</span><span> Bai Zhong De 2023</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="" href="">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"></div><!--  a(title="github-button" class="github-button" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true") --></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>